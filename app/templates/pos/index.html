{% extends "base.html" %}

{% block title %}POS | Cid-POS{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3" style="background-color: #f8f9fa; min-height: 100vh;">
  <div class="row g-3">
    <!-- Left Column: Products (8 cols) -->
    <div class="col-md-8">
      <!-- Search & Categories -->
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="fa fa-search"></i></span>
              <input type="text" id="productSearch" class="form-control" placeholder="Search products by name or barcode...">
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary btn-sm pos-category-btn active" data-category="">All</button>
            {% for category in categories %}
            <button class="btn btn-outline-secondary btn-sm pos-category-btn" data-category="{{ category.id }}">
              {{ category.name }}
            </button>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Products Grid -->
      <div class="row row-cols-3 row-cols-lg-4 g-3" id="productGrid">
        {% for product in products %}
        <div class="col pos-product-card" 
             data-name="{{ product.name | lower }}" 
             data-barcode="{{ product.barcode | lower }}"
             data-category="{{ product.category_id or '' }}"
             data-id="{{ product.id }}"
             data-name-attr="{{ product.name }}"
             data-price="{{ product.price }}"
             data-stock="{{ product.stock }}"
             data-unit-short="{{ product.unit.short_name if product.unit else '' }}">
          <div class="card h-100 pos-product-card-inner" style="border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
            <div style="height: 140px; width: 100%; overflow: hidden; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
              <img src="{% if product.image_url %}{{ product.image_url }}{% elif product.image_file %}{{ url_for('static', filename='uploads/' + product.image_file) }}{% else %}https://via.placeholder.com/200x140?text=Product{% endif %}" 
                   alt="{{ product.name }}" 
                   style="max-width: 100%; max-height: 100%; object-fit: contain;">
            </div>
            <div class="card-body" style="padding: 10px;">
              <h6 class="card-title mb-1" style="font-size: 14px; font-weight: 600; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ product.name }}</h6>
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold" style="color: #4299e1; font-size: 14px;">{{ '{:,.0f}'.format(product.price or 0) }} Ks</span>
                {% if product.stock > 0 %}
                <small class="badge bg-success" style="font-size: 11px;">Stock: {{ product.stock }}</small>
                {% else %}
                <small class="badge bg-danger" style="font-size: 11px;">Out of Stock</small>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right Column: Cart Panel (4 cols) -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm" style="height: calc(100vh - 80px); display: flex; flex-direction: column; background-color: #ffffff;">
        <div class="card-header bg-white border-bottom" style="padding: 1rem;">
          <h5 class="mb-0">Current Order</h5>
        </div>
        <div class="card-body p-0" style="flex: 1; overflow-y: auto;">
          <table class="table table-sm mb-0" id="cartTable" style="border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="padding: 0.75rem; font-size: 12px; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Item</th>
                <th style="padding: 0.75rem; font-size: 12px; font-weight: 600; text-align: center; border-bottom: 1px solid #e2e8f0; width: 100px;">Qty</th>
                <th style="padding: 0.75rem; font-size: 12px; font-weight: 600; text-align: right; border-bottom: 1px solid #e2e8f0; width: 80px;">Total</th>
                <th style="padding: 0.75rem; font-size: 12px; font-weight: 600; text-align: center; border-bottom: 1px solid #e2e8f0; width: 40px;"></th>
              </tr>
            </thead>
            <tbody id="cartTableBody">
              <tr>
                <td colspan="4" class="text-center text-muted py-4" style="font-size: 14px;">Cart is empty</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-footer border-top" style="padding: 1rem;">
          <!-- Customer & Payment -->
          <div class="mb-3">
            <label class="form-label small fw-semibold mb-1">Customer</label>
            <select class="form-select form-select-sm" id="customerSelect">
              <option value="">Walk-in Customer</option>
              {% for c in customers %}
              <option value="{{ c.id }}">{{ c.name }}{% if c.phone %} ({{ c.phone }}){% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold mb-1">Payment Method</label>
            <select class="form-select form-select-sm" id="paymentMethodSelect">
              <option value="cash">üíµ Cash</option>
              <option value="kpay">üì± KPay</option>
              <option value="wavepay">üü® WavePay</option>
              <option value="credit">üìù Credit</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label small fw-semibold mb-1">Discount (Ks)</label>
            <input type="number" class="form-control form-control-sm" id="discountInput" value="0" min="0" step="0.01" placeholder="0">
          </div>
          
          <!-- Totals -->
          <div class="border-top pt-2 mb-3" style="border-color: #e2e8f0 !important;">
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Subtotal</span>
              <span class="small" id="subtotalLabel">0 Ks</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Tax</span>
              <span class="small" id="taxLabel">0 Ks</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Discount</span>
              <span class="small text-danger" id="discountLabel">0 Ks</span>
            </div>
            <div class="d-flex justify-content-between mt-2 pt-2 border-top" style="border-color: #e2e8f0 !important;">
              <span class="fw-bold">Grand Total</span>
              <span class="fw-bold fs-5" id="totalLabel" style="color: #4299e1;">0 Ks</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-grid">
            <button class="btn btn-success" id="checkoutBtn">
              <i class="fa fa-cash-register me-1"></i>Payment
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 360px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="receiptModalLabel">Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="receipt" class="mx-auto" style="max-width: 320px;">
          <div class="text-center">
            {% if store.logo_filename and store.show_logo_on_receipt %}
            <img src="{{ url_for('static', filename='uploads/logo/' + store.logo_filename) }}" 
                 alt="Shop Logo" 
                 class="receipt-logo">
            {% endif %}
            <h6 class="mb-0">{{ store.shop_name }}</h6>
            {% if store.address %}
            <small class="text-muted">{{ store.address }}</small><br>
            {% endif %}
            {% if store.phone %}
            <small class="text-muted">{{ store.phone }}</small><br>
            {% endif %}
            {% if store.receipt_header %}
            <small class="text-muted">{{ store.receipt_header }}</small><br>
            {% endif %}
            <small id="rcptDate"></small><br>
            <small id="rcptInvoice"></small>
          </div>
          <hr class="my-2" style="border-style: dashed;">
          <div id="rcptItems" class="small"></div>
          <hr class="my-2" style="border-style: dashed;">
          <div class="d-flex justify-content-between">
            <span class="fw-semibold">Subtotal</span>
            <span id="rcptSubtotal"></span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Tax</span>
            <span id="rcptTax"></span>
          </div>
          <div class="d-flex justify-content-between d-none" id="rcptDiscountRow">
            <span>Discount</span>
            <span id="rcptDiscount" class="text-danger"></span>
          </div>
          <div class="d-flex justify-content-between fw-bold">
            <span>Total</span>
            <span id="rcptTotal"></span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Payment</span>
            <span id="rcptPayment"></span>
          </div>
          <div class="d-flex justify-content-between d-none" id="rcptBalanceRow">
            <span>Current Balance</span>
            <span id="rcptBalance"></span>
          </div>
          <div class="text-center mt-3">
            <small class="text-muted">{{ store.receipt_footer }}</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="printReceiptBtn"><i class="fa fa-print me-1"></i>Print</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Remove fullscreen class if it exists
  document.body.classList.remove('pos-fullscreen');
  
  const cart = {};
  const formatKs = (value) => `${Number(value || 0).toLocaleString()} Ks`;

  function calculateTotal() {
    const items = Object.values(cart);
    const subtotal = items.reduce((sum, i) => sum + (i.price || 0) * (i.qty || 0), 0);
    const tax = 0;
    const discountInput = document.getElementById('discountInput');
    let discount = parseFloat(discountInput.value || 0);
    
    if (discount > subtotal) {
      discount = subtotal;
      discountInput.value = subtotal;
    }
    if (discount < 0) {
      discount = 0;
      discountInput.value = 0;
    }
    
    const total = subtotal + tax - discount;
    
    document.getElementById('subtotalLabel').textContent = formatKs(subtotal);
    document.getElementById('taxLabel').textContent = formatKs(tax);
    document.getElementById('discountLabel').textContent = formatKs(discount);
    document.getElementById('totalLabel').textContent = formatKs(total);
    
    return { subtotal, tax, discount, total };
  }

  function renderCart() {
    const tbody = document.getElementById('cartTableBody');
    const items = Object.values(cart);
    
    if (!items.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4" style="font-size: 14px;">Cart is empty</td></tr>';
    } else {
      tbody.innerHTML = items.map(item => {
        const maxStock = item.stock || 0;
        return `
          <tr style="border-bottom: 1px dashed #ccc;">
            <td style="padding: 0.75rem; font-size: 13px;">${item.name}</td>
            <td style="padding: 0.75rem; text-align: center;">
              <div class="d-flex align-items-center justify-content-center gap-1">
                <button class="btn btn-sm btn-outline-secondary pos-qty-decrease" data-id="${item.id}" style="width: 28px; height: 28px; padding: 0; line-height: 1;">-</button>
                <input type="number" min="1" max="${maxStock}" class="form-control form-control-sm pos-qty-input" 
                       data-id="${item.id}" 
                       data-stock="${maxStock}"
                       value="${item.qty}" 
                       style="width: 50px; text-align: center; padding: 0.25rem;">
                <button class="btn btn-sm btn-outline-secondary pos-qty-increase" data-id="${item.id}" style="width: 28px; height: 28px; padding: 0; line-height: 1;">+</button>
              </div>
            </td>
            <td style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 13px;">${formatKs(item.price * item.qty)}</td>
            <td style="padding: 0.75rem; text-align: center;">
              <button class="btn btn-sm btn-outline-danger pos-cart-remove" data-id="${item.id}" style="width: 28px; height: 28px; padding: 0; line-height: 1;">
                <i class="fa fa-times" style="font-size: 12px;"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
    calculateTotal();
  }

  function addToCart(product) {
    const productCard = document.querySelector(`.pos-product-card[data-id="${product.id}"]`);
    const currentStock = productCard ? parseInt(productCard.dataset.stock || 0) : (product.stock || 0);
    
    const existing = cart[product.id];
    const newQty = existing ? existing.qty + 1 : 1;
    
    if (newQty > currentStock) {
      Toast.fire({
        icon: 'error',
        title: 'Insufficient Stock!',
        text: `Only ${currentStock} available for ${product.name}`
      });
      return;
    }
    
    if (existing) {
      existing.qty += 1;
      existing.stock = currentStock;
    } else {
      cart[product.id] = { 
        ...product, 
        qty: 1, 
        unit_short: product.unit_short || '',
        stock: currentStock
      };
    }
    
    Toast.fire({
      icon: 'success',
      title: 'Added',
      text: `${product.name} +1`,
      timer: 1500
    });
    
    renderCart();
  }

  // Product card click
  document.addEventListener('click', (e) => {
    const productCard = e.target.closest('.pos-product-card');
    if (productCard) {
      const product = {
        id: parseInt(productCard.dataset.id),
        name: productCard.dataset.nameAttr,
        price: parseFloat(productCard.dataset.price || 0),
        stock: parseInt(productCard.dataset.stock || 0),
        unit_short: productCard.dataset.unitShort || ''
      };
      addToCart(product);
    }
    
    // Quantity controls
    if (e.target.closest('.pos-qty-decrease')) {
      const id = parseInt(e.target.closest('.pos-qty-decrease').dataset.id);
      if (cart[id] && cart[id].qty > 1) {
        cart[id].qty -= 1;
        renderCart();
      }
    }
    if (e.target.closest('.pos-qty-increase')) {
      const id = parseInt(e.target.closest('.pos-qty-increase').dataset.id);
      if (cart[id]) {
        const qtyInput = e.target.closest('.pos-qty-increase').closest('tr')?.querySelector('.pos-qty-input');
        const maxStock = qtyInput ? parseInt(qtyInput.dataset.stock || 0) : (cart[id].stock || 0);
        if (cart[id].qty < maxStock) {
          cart[id].qty += 1;
          renderCart();
        } else {
          Toast.fire({
            icon: 'error',
            title: 'Insufficient Stock!',
            text: `Only ${maxStock} available`
          });
        }
      }
    }
    
    // Remove item
    if (e.target.closest('.pos-cart-remove')) {
      const id = parseInt(e.target.closest('.pos-cart-remove').dataset.id);
      delete cart[id];
      renderCart();
    }
    
    // Category filter
    if (e.target.closest('.pos-category-btn')) {
      const btn = e.target.closest('.pos-category-btn');
      document.querySelectorAll('.pos-category-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const categoryId = btn.dataset.category;
      
      document.querySelectorAll('.pos-product-card').forEach(card => {
        const cardCategory = card.dataset.category || '';
        if (!categoryId || cardCategory === categoryId) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }
  });

  document.addEventListener('input', (e) => {
    if (e.target.classList.contains('pos-qty-input')) {
      const id = parseInt(e.target.dataset.id);
      const maxStock = parseInt(e.target.dataset.stock || 0);
      let qty = parseInt(e.target.value || 1);
      
      if (cart[id]) {
        if (qty > maxStock) {
          qty = maxStock;
          Toast.fire({
            icon: 'warning',
            title: 'Quantity Adjusted',
            text: `Maximum available stock is ${maxStock}. Quantity adjusted to ${maxStock}.`
          });
        }
        qty = Math.max(1, qty);
        cart[id].qty = qty;
        renderCart();
      }
    }
    if (e.target.id === 'discountInput') {
      calculateTotal();
    }
  });

  // Search filter
  document.getElementById('productSearch').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const activeCategory = document.querySelector('.pos-category-btn.active')?.dataset.category || '';
    
    document.querySelectorAll('.pos-product-card').forEach(card => {
      const name = card.dataset.name;
      const barcode = card.dataset.barcode;
      const category = card.dataset.category || '';
      const match = (name.includes(term) || barcode.includes(term)) && 
                    (!activeCategory || category === activeCategory);
      card.style.display = match ? '' : 'none';
    });
  });

  // Checkout
  document.getElementById('checkoutBtn').addEventListener('click', async () => {
    const items = Object.values(cart);
    if (!items.length) {
      Toast.fire({
        icon: 'warning',
        title: 'Cart is empty'
      });
      return;
    }
    const customerId = document.getElementById('customerSelect').value || null;
    const paymentMethod = document.getElementById('paymentMethodSelect').value;
    const totals = calculateTotal();
    
    const payload = {
      cart_items: items.map(i => ({
        product_id: i.id,
        quantity: i.qty,
        price: i.price
      })),
      tax: totals.tax,
      discount: totals.discount,
      payment_method: paymentMethod,
      customer_id: customerId ? parseInt(customerId) : null
    };
    
    const loadingToast = Toast.fire({
      icon: 'info',
      title: 'Processing Sale...',
      didOpen: () => {
        Swal.showLoading();
      },
      timer: 0
    });
    
    try {
      const res = await fetch("{{ url_for('pos.checkout') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      
      Swal.close();
      
      if (!res.ok) {
        Toast.fire({
          icon: 'error',
          title: data.message || 'Checkout failed',
          timer: 3000
        });
        return;
      }
      
      Toast.fire({
        icon: 'success',
        title: 'Sale Complete!',
        timer: 2000
      });
      
      showReceipt({
        invoice_no: data.invoice_no,
        items: items.map(i => ({ ...i, unit_short: i.unit_short || '' })),
        subtotal: totals.subtotal,
        tax: totals.tax,
        discount: totals.discount,
        total: data.total,
        payment_method: data.payment_method,
        customer_balance: data.customer_balance
      });
    } catch (err) {
      console.error(err);
      Swal.close();
      Toast.fire({
        icon: 'error',
        title: 'Error processing checkout',
        timer: 3000
      });
    }
  });

  function showReceipt({ invoice_no, items, subtotal, tax, discount, total, payment_method, customer_balance }) {
    document.getElementById('rcptInvoice').textContent = `Invoice: ${invoice_no}`;
    document.getElementById('rcptDate').textContent = new Date().toLocaleString();

    const itemsContainer = document.getElementById('rcptItems');
    itemsContainer.innerHTML = items.map(i => `
      <div class="d-flex justify-content-between">
        <div>${i.name} x${i.qty}</div>
        <div>${formatKs(i.price * i.qty)}</div>
      </div>
    `).join('');

    document.getElementById('rcptSubtotal').textContent = formatKs(subtotal);
    document.getElementById('rcptTax').textContent = formatKs(tax);
    const discountRow = document.getElementById('rcptDiscountRow');
    if (discount > 0) {
      document.getElementById('rcptDiscount').textContent = `-${formatKs(discount)}`;
      discountRow.classList.remove('d-none');
    } else {
      discountRow.classList.add('d-none');
    }
    document.getElementById('rcptTotal').textContent = formatKs(parseFloat(total));
    
    const paymentLabels = {
      'cash': 'üíµ Cash',
      'kpay': 'üì± KPay',
      'wavepay': 'üü® WavePay',
      'credit': 'üìù Credit'
    };
    document.getElementById('rcptPayment').textContent = paymentLabels[payment_method.toLowerCase()] || payment_method;
    const balanceRow = document.getElementById('rcptBalanceRow');
    if (payment_method === 'credit' && customer_balance !== null && customer_balance !== undefined) {
      document.getElementById('rcptBalance').textContent = formatKs(parseFloat(customer_balance));
      balanceRow.classList.remove('d-none');
    } else {
      balanceRow.classList.add('d-none');
    }

    const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
    modal.show();

    const autoPrint = {% if store.auto_print %}true{% else %}false{% endif %};
    if (autoPrint) {
      setTimeout(() => {
        window.print();
      }, 500);
    }

    const receiptEl = document.getElementById('receiptModal');
    receiptEl.addEventListener('hidden.bs.modal', () => {
      Object.keys(cart).forEach(k => delete cart[k]);
      renderCart();
    }, { once: true });
  }

  document.getElementById('printReceiptBtn').addEventListener('click', () => {
    window.print();
  });

  renderCart();
</script>

<style>
/* Product Card Hover Effect */
.pos-product-card-inner:hover {
  border-color: #4299e1 !important;
  box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
}

/* Receipt Logo Styling */
.receipt-logo {
  max-width: 60%;
  max-height: 80px;
  display: block;
  margin: 0 auto 10px;
  filter: grayscale(100%) contrast(120%);
}

@media print {
  body * {
    visibility: hidden;
  }
  #receipt, #receipt * {
    visibility: visible;
  }
  #receipt {
    position: absolute;
    left: 0;
    top: 0;
    {% if store.printer_paper_size == '58mm' %}
    width: 48mm;
    font-size: 10px;
    {% elif store.printer_paper_size == '80mm' %}
    width: 72mm;
    font-size: 12px;
    {% else %}
    width: 180mm;
    font-size: 14px;
    {% endif %}
    padding-left: {{ store.print_padding or 0 }}px;
    margin: 0;
    padding-top: 0;
    padding-right: 0;
    padding-bottom: 0;
  }
  #receipt h6 {
    font-size: {% if store.printer_paper_size == '58mm' %}12px{% elif store.printer_paper_size == '80mm' %}14px{% else %}16px{% endif %};
  }
  #receipt small {
    font-size: {% if store.printer_paper_size == '58mm' %}9px{% elif store.printer_paper_size == '80mm' %}11px{% else %}13px{% endif %};
  }
  .receipt-logo {
    max-width: 60%;
    max-height: 80px;
    display: block;
    margin: 0 auto 10px;
    filter: grayscale(100%) contrast(120%);
  }
}
</style>
{% endblock %}
