{% extends "base.html" %}

{% block title %}Barcode Labels | Smart POS{% endblock %}

{% block content %}
<div class="container-fluid px-0">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
      <i class="fa fa-barcode me-2"></i>Barcode Label Printer
    </h4>
  </div>

  <div class="row g-3">
    <!-- Left Column: Product Search & Add -->
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h6 class="mb-0">Search & Add Products</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="fa fa-search"></i></span>
              <input type="text" id="productSearch" class="form-control" placeholder="Search by name or barcode...">
            </div>
          </div>
          
          <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
            <table class="table table-sm table-hover">
              <thead class="table-light sticky-top">
                <tr>
                  <th>Product</th>
                  <th class="text-center">Barcode</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody id="productList">
                {% for product in products %}
                <tr class="product-item-row" data-name="{{ product.name | lower }}" data-barcode="{{ product.barcode | lower }}">
                  <td>
                    <div class="fw-semibold">{{ product.name }}</div>
                    <small class="text-muted">{{ "{:,.0f} Ks".format(product.price or 0) }}</small>
                  </td>
                  <td class="text-center">
                    <code>{{ product.barcode }}</code>
                  </td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-success add-to-queue" 
                            data-product-id="{{ product.id }}"
                            data-product-name="{{ product.name }}"
                            data-product-barcode="{{ product.barcode }}"
                            data-product-price="{{ product.price }}">
                      <i class="fa fa-plus"></i> Add
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Print Queue -->
    <div class="col-lg-7">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Print Queue</h6>
          <span class="badge bg-primary" id="queueCount">0 items</span>
        </div>
        <div class="card-body">
          <!-- Settings -->
          <div class="mb-3 p-3 bg-light rounded">
            <label class="form-label fw-semibold">Paper Size</label>
            <select id="paperSize" class="form-select">
              <option value="thermal_50x30">Thermal 50x30mm</option>
              <option value="continuous">Continuous (58mm)</option>
              <option value="a4_grid">A4 Grid (8 per page)</option>
            </select>
            <small class="text-muted">Select the label paper size you're using</small>
          </div>

          <!-- Queue Table -->
          <div class="table-responsive" style="max-height: 50vh; overflow-y: auto;">
            <table class="table table-sm" id="queueTable">
              <thead class="table-light sticky-top">
                <tr>
                  <th>Product</th>
                  <th class="text-center">Barcode</th>
                  <th class="text-center" style="width: 120px;">Quantity</th>
                  <th class="text-center" style="width: 80px;">Action</th>
                </tr>
              </thead>
              <tbody id="queueBody">
                <tr id="emptyQueue">
                  <td colspan="4" class="text-center text-muted py-4">
                    <i class="fa fa-inbox fa-2x mb-2 opacity-25"></i>
                    <p class="mb-0">No products in queue</p>
                    <small>Search and add products to start printing labels</small>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Print Button -->
          <div class="mt-3 text-center">
            <button class="btn btn-primary btn-lg" id="printBtn" disabled>
              <i class="fa fa-print me-2"></i>Print Labels
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const printQueue = [];
  const allProducts = {{ products_json | tojson }};

  // Product Search
  document.getElementById('productSearch').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.product-item-row').forEach(row => {
      const name = row.dataset.name;
      const barcode = row.dataset.barcode;
      const match = name.includes(term) || barcode.includes(term);
      row.style.display = match ? '' : 'none';
    });
  });

  // Add to Queue
  document.querySelectorAll('.add-to-queue').forEach(btn => {
    btn.addEventListener('click', function() {
      const productId = parseInt(this.dataset.productId);
      const productName = this.dataset.productName;
      const productBarcode = this.dataset.productBarcode;
      const productPrice = parseFloat(this.dataset.productPrice);

      // Check if already in queue
      const existing = printQueue.find(item => item.product_id === productId);
      if (existing) {
        existing.quantity += 1;
        updateQueueDisplay();
        return;
      }

      // Add new item
      printQueue.push({
        product_id: productId,
        product_name: productName,
        product_barcode: productBarcode,
        product_price: productPrice,
        quantity: 1
      });

      updateQueueDisplay();
    });
  });

  // Update Queue Display
  function updateQueueDisplay() {
    const queueBody = document.getElementById('queueBody');
    const emptyQueue = document.getElementById('emptyQueue');
    const printBtn = document.getElementById('printBtn');
    const queueCount = document.getElementById('queueCount');

    if (printQueue.length === 0) {
      queueBody.innerHTML = `
        <tr id="emptyQueue">
          <td colspan="4" class="text-center text-muted py-4">
            <i class="fa fa-inbox fa-2x mb-2 opacity-25"></i>
            <p class="mb-0">No products in queue</p>
            <small>Search and add products to start printing labels</small>
          </td>
        </tr>
      `;
      printBtn.disabled = true;
      queueCount.textContent = '0 items';
      return;
    }

    // Build queue table
    let html = '';
    printQueue.forEach((item, index) => {
      html += `
        <tr>
          <td>
            <div class="fw-semibold">${item.product_name}</div>
            <small class="text-muted">${Number(item.product_price).toLocaleString()} Ks</small>
          </td>
          <td class="text-center"><code>${item.product_barcode}</code></td>
          <td class="text-center">
            <input type="number" class="form-control form-control-sm quantity-input" 
                   value="${item.quantity}" min="1" max="100"
                   data-index="${index}" style="width: 80px;">
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
    queueBody.innerHTML = html;
    printBtn.disabled = false;
    queueCount.textContent = `${printQueue.length} item${printQueue.length !== 1 ? 's' : ''}`;

    // Attach event listeners
    document.querySelectorAll('.quantity-input').forEach(input => {
      input.addEventListener('change', function() {
        const index = parseInt(this.dataset.index);
        printQueue[index].quantity = parseInt(this.value) || 1;
      });
    });

    document.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        printQueue.splice(index, 1);
        updateQueueDisplay();
      });
    });
  }

  // Print Labels
  document.getElementById('printBtn').addEventListener('click', async function() {
    if (printQueue.length === 0) {
      Toast.fire({
        icon: 'warning',
        title: 'Queue is empty'
      });
      return;
    }

    const paperSize = document.getElementById('paperSize').value;
    
    // Prepare items for backend
    const items = printQueue.map(item => ({
      product_id: item.product_id,
      quantity: item.quantity
    }));

    // Show loading toast
    const loadingToast = Toast.fire({
      icon: 'info',
      title: 'Generating labels...',
      didOpen: () => {
        Swal.showLoading();
      },
      timer: 0
    });

    try {
      const response = await fetch("{{ url_for('inventory.print_labels') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: items,
          paper_size: paperSize
        })
      });

      if (!response.ok) {
        Swal.close();
        Toast.fire({
          icon: 'error',
          title: 'Failed to generate labels',
          timer: 3000
        });
        return;
      }

      // Get HTML response directly
      const html = await response.text();
      
      if (!response.ok) {
        Swal.close();
        try {
          const error = JSON.parse(html);
          Toast.fire({
            icon: 'error',
            title: error.error || 'Failed to generate labels',
            timer: 3000
          });
        } catch {
          Toast.fire({
            icon: 'error',
            title: 'Failed to generate labels',
            timer: 3000
          });
        }
        return;
      }
      
      Swal.close();
      
      // Create a new window for printing
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        Toast.fire({
          icon: 'error',
          title: 'Please allow popups to print labels',
          timer: 3000
        });
        return;
      }
      
      printWindow.document.write(html);
      printWindow.document.close();
      
      // Wait for images to load, then print
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
        }, 1000);
      };
    } catch (error) {
      console.error(error);
      Swal.close();
      Toast.fire({
        icon: 'error',
        title: 'Error generating labels',
        timer: 3000
      });
    }
  });
</script>
{% endblock %}
