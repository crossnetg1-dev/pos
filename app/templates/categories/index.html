{% extends "base.html" %}

{% block title %}Categories | Smart POS{% endblock %}

{% block content %}
<div class="container-fluid px-0">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Category Management</h4>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
      <i class="fa fa-plus me-1"></i>Add New Category
    </button>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Parent</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if categories %}
              {% for category in categories %}
              <tr>
                <td>{{ category.id }}</td>
                <td>
                  {% if category.parent_id %}
                  <span class="text-muted">└─</span>
                  {% endif %}
                  <strong>{{ category.name }}</strong>
                </td>
                <td>
                  {% if category.parent %}
                  <span class="badge bg-info">{{ category.parent.name }}</span>
                  {% else %}
                  <span class="text-muted">Main Category</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <button class="btn btn-sm btn-outline-primary me-1 edit-category" 
                          data-category-id="{{ category.id }}"
                          data-category-name="{{ category.name }}"
                          data-category-parent-id="{{ category.parent_id or '' }}">
                    <i class="fa fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-category" 
                          data-category-id="{{ category.id }}"
                          data-category-name="{{ category.name }}">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4">No categories found. Add your first category above.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('categories.add') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Category Name <span class="text-danger">*</span></label>
            <input type="text" name="name" class="form-control" required autofocus>
          </div>
          <div class="mb-3">
            <label class="form-label">Parent Category</label>
            <select name="parent_id" class="form-select">
              <option value="">Main Category (No Parent)</option>
              {% for cat in main_categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
            <small class="text-muted">Leave empty for main category, or select a parent to create a sub-category</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editCategoryForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Category Name <span class="text-danger">*</span></label>
            <input type="text" name="name" id="editCategoryName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Parent Category</label>
            <select name="parent_id" id="editCategoryParent" class="form-select">
              <option value="">Main Category (No Parent)</option>
              {% for cat in main_categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
            <small class="text-muted">Leave empty for main category, or select a parent to create a sub-category</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Category</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Edit Category
  document.querySelectorAll('.edit-category').forEach(btn => {
    btn.addEventListener('click', function() {
      const categoryId = this.dataset.categoryId;
      const categoryName = this.dataset.categoryName;
      const categoryParentId = this.dataset.categoryParentId || '';
      
      document.getElementById('editCategoryName').value = categoryName;
      document.getElementById('editCategoryParent').value = categoryParentId;
      document.getElementById('editCategoryForm').action = `/categories/edit/${categoryId}`;
      
      const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
      modal.show();
    });
  });

  // Delete Category
  document.querySelectorAll('.delete-category').forEach(btn => {
    btn.addEventListener('click', function() {
      const categoryId = this.dataset.categoryId;
      const categoryName = this.dataset.categoryName;
      
      if (confirm(`Are you sure you want to delete "${categoryName}"? Products using this category will be set to "No Category".`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/categories/delete/${categoryId}`;
        document.body.appendChild(form);
        form.submit();
      }
    });
  });
</script>
{% endblock %}
